<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arena - Play & Earn</title>
    
    <!-- Config & Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        const APP_VERSION = "1.0"; 
        tailwind.config = {
            darkMode: 'class',
            theme: { 
                extend: { 
                    colors: { darkBg: '#0f172a', darkCard: '#1e293b', darkText: '#f8fafc' },
                    animation: { 'bounce-short': 'bounce 0.5s infinite' }
                } 
            }
        }
    </script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <!-- Storage hata diya kyunki ab hum direct Database use karenge (Faster) -->

    <style>
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .btn-anim:active { transform: scale(0.95); }
        .filter-type-active { color: #2563eb; border-bottom: 2px solid #2563eb; }
        .filter-mode-active { background-color: #2563eb; color: white; box-shadow: 0 4px 6px -1px rgba(37, 99, 235, 0.3); }
        .filter-mode-inactive { background-color: #f3f4f6; color: #6b7280; }
        .dark .filter-mode-inactive { background-color: #334155; color: #94a3b8; }
        .tab-active { border-bottom: 2px solid #3b82f6; color: #3b82f6; transition: all 0.3s; }
        .tab-inactive { color: #9ca3af; transition: all 0.3s; }
        .nav-active { color: #3b82f6; transform: translateY(-2px); transition: all 0.3s; }
        .nav-inactive { color: #9ca3af; transition: all 0.3s; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .animate-fade { animation: fadeIn 0.4s ease-out; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .animate-slide-up { animation: slideUp 0.5s ease-out forwards; }
        @keyframes popIn { 0% { opacity: 0; transform: scale(0.9); } 100% { opacity: 1; transform: scale(1); } }
        .animate-pop { animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
    </style>
</head>
<body class="bg-gray-100 dark:bg-darkBg text-gray-800 dark:text-gray-200 font-sans antialiased min-h-screen select-none transition-colors duration-300">

    <div class="max-w-md mx-auto bg-gray-50 dark:bg-slate-900 min-h-screen relative shadow-2xl overflow-hidden pb-36 transition-colors duration-300">
        
        <!-- HEADER -->
        <header class="bg-gradient-to-r from-blue-600 to-indigo-600 p-4 shadow-lg sticky top-0 z-40">
            <div class="flex justify-between items-center text-white">
                <div class="flex items-center gap-2"><i class="fa-solid fa-gamepad text-2xl animate-pulse"></i><h1 class="text-xl font-bold tracking-wide italic">ARENA</h1></div>
                <div class="flex items-center gap-3">
                    <div class="relative cursor-pointer btn-anim" onclick="alert('No new notifications')">
                        <i class="fa-solid fa-bell text-xl hover:rotate-12 transition-transform"></i>
                    </div>
                    <div id="header-balance" class="bg-black/20 backdrop-blur-md px-4 py-1.5 rounded-full text-sm font-bold border border-white/10 hidden animate-fade">â‚¹0</div>
                </div>
            </div>
        </header>

        <!-- LOGIN SCREEN -->
        <div id="auth-screen" class="p-6 flex flex-col justify-center h-[85vh] animate-fade">
            <div class="text-center mb-10">
                <div class="w-24 h-24 bg-blue-100 dark:bg-slate-800 rounded-full mx-auto flex items-center justify-center text-4xl text-blue-600 mb-4 shadow-inner animate-bounce-short"><i class="fa-solid fa-user-ninja"></i></div>
                <h2 class="text-3xl font-bold dark:text-white">Welcome</h2>
                <p class="text-gray-500 dark:text-gray-400 mt-2">Enter details to start playing.</p>
            </div>
            <div class="bg-white dark:bg-darkCard p-6 rounded-2xl shadow-xl text-center transform transition hover:scale-[1.02] duration-300">
                <input type="text" id="login-name" placeholder="Full Name" class="w-full mb-3 p-3 rounded-xl border bg-gray-50 dark:bg-slate-800 dark:border-gray-600 dark:text-white text-center font-bold focus:ring-2 focus:ring-blue-500 outline-none">
                <input type="tel" id="login-phone" placeholder="Mobile Number" class="w-full mb-6 p-3 rounded-xl border bg-gray-50 dark:bg-slate-800 dark:border-gray-600 dark:text-white text-center font-bold tracking-widest focus:ring-2 focus:ring-blue-500 outline-none">
                <button id="btn-login" onclick="handleLogin()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3.5 rounded-xl shadow-lg btn-anim text-lg transition-colors">Let's Play</button>
            </div>
        </div>

        <!-- APP SCREENS -->
        <div id="app-screens" class="hidden">
            <!-- HOME -->
            <div id="screen-home" class="relative animate-fade">
                <div class="bg-white dark:bg-darkCard shadow-sm sticky top-0 z-40 px-4 py-3 border-b dark:border-gray-700">
                    <div class="flex justify-around mb-2 border-b dark:border-gray-600 pb-2">
                        <button onclick="switchHomeTab('matches')" id="htab-matches" class="flex-1 pb-1 font-bold tab-active">Matches</button>
                        <button onclick="switchHomeTab('giveaways')" id="htab-giveaways" class="flex-1 pb-1 font-bold tab-inactive">Giveaways</button>
                    </div>
                    <!-- FILTERS -->
                    <div id="matches-filters" class="pt-2 animate-slide-up">
                        <div class="flex gap-6 text-sm font-bold text-gray-400 dark:text-gray-500 mb-3 pb-1">
                            <button onclick="setFilterType('All')" id="btn-type-All" class="filter-type-active pb-1 transition">All</button>
                            <button onclick="setFilterType('CS')" id="btn-type-CS" class="hover:text-blue-500 pb-1 transition">CS</button>
                            <button onclick="setFilterType('BR')" id="btn-type-BR" class="hover:text-blue-500 pb-1 transition">BR</button>
                        </div>
                        <div class="flex gap-2 overflow-x-auto no-scrollbar">
                            <button onclick="setFilterMode('All')" id="btn-mode-All" class="filter-mode-active px-4 py-1.5 rounded-full text-xs font-bold transition shadow-sm btn-anim">All</button>
                            <button onclick="setFilterMode('Squad')" id="btn-mode-Squad" class="filter-mode-inactive px-4 py-1.5 rounded-full text-xs font-bold transition btn-anim">SQUAD</button>
                            <button onclick="setFilterMode('Duo')" id="btn-mode-Duo" class="filter-mode-inactive px-4 py-1.5 rounded-full text-xs font-bold transition btn-anim">DUO</button>
                            <button onclick="setFilterMode('Solo')" id="btn-mode-Solo" class="filter-mode-inactive px-4 py-1.5 rounded-full text-xs font-bold transition btn-anim">SOLO</button>
                        </div>
                    </div>
                </div>
                <div class="p-4 space-y-5">
                    <div id="view-matches"><div id="tournament-list" class="space-y-4 pb-4 min-h-[300px]"><div class="text-center text-gray-400 mt-10 animate-pulse">Loading Matches...</div></div></div>
                    <div id="view-giveaways" class="hidden"><div id="giveaway-list" class="space-y-4 pb-4 min-h-[300px]"><div class="text-center text-gray-400 mt-10 animate-pulse">Loading Giveaways...</div></div></div>
                </div>
            </div>

            <!-- WALLET -->
            <div id="screen-wallet" class="hidden p-4 animate-fade">
                <div class="bg-gradient-to-br from-indigo-600 to-blue-500 rounded-2xl p-6 text-white shadow-xl mb-6 text-center relative overflow-hidden transform hover:scale-[1.01] transition duration-300">
                    <div class="absolute top-0 -left-full w-full h-full bg-gradient-to-r from-transparent via-white/20 to-transparent animate-[shimmer_2s_infinite]"></div>
                    <p class="text-blue-100 text-sm font-medium">Total Balance</p>
                    <h1 class="text-5xl font-bold mt-2" id="wallet-balance">â‚¹0</h1>
                    <div class="flex gap-3 justify-center mt-6 relative z-10">
                        <button onclick="openModal('payment-modal')" class="bg-white text-blue-600 px-6 py-2 rounded-full font-bold shadow-lg btn-anim hover:bg-gray-50 transition">Add Cash</button>
                        <button onclick="openModal('withdraw-modal')" class="bg-white/20 text-white border border-white/40 px-6 py-2 rounded-full font-bold shadow-lg btn-anim hover:bg-white/30 transition">Withdraw</button>
                    </div>
                </div>
                <div class="bg-white dark:bg-darkCard rounded-xl shadow-sm border dark:border-gray-700 p-6 animate-slide-up">
                    <h4 class="font-bold text-gray-700 dark:text-gray-300 mb-2 border-b dark:border-gray-700 pb-2">History</h4>
                    <div id="payment-history" class="text-sm text-gray-500 space-y-2 h-40 overflow-y-auto">Loading...</div>
                </div>
            </div>

            <!-- PROFILE -->
            <div id="screen-profile" class="hidden p-4 animate-fade">
                <div class="bg-white dark:bg-darkCard rounded-2xl shadow-sm border dark:border-gray-700 p-6 text-center mb-5 transform transition hover:translate-y-[-2px]">
                    <div class="w-24 h-24 bg-gray-100 dark:bg-slate-800 rounded-full mx-auto mb-3 flex items-center justify-center text-4xl text-gray-400 shadow-inner"><i class="fa-solid fa-user"></i></div>
                    <h2 id="profile-name" class="font-bold text-xl text-gray-800 dark:text-white">Player</h2>
                    <p class="text-xs text-gray-500 dark:text-gray-400 mt-1"><span id="profile-phone">...</span></p>
                </div>
                <button onclick="openModal('hacker-modal')" class="w-full bg-red-600 text-white font-bold py-3 px-4 rounded-xl shadow-md mb-4 flex items-center justify-between btn-anim hover:bg-red-700 transition">
                    <span class="flex items-center gap-2"><i class="fa-solid fa-user-secret"></i> Report Hacker</span><i class="fa-solid fa-chevron-right"></i>
                </button>
                <div class="bg-white dark:bg-darkCard rounded-xl shadow-sm border dark:border-gray-700 overflow-hidden mb-5 animate-slide-up">
                    <h3 class="bg-gray-50 dark:bg-slate-800 px-4 py-2 text-xs font-bold text-gray-500 uppercase tracking-wider">Settings</h3>
                    <div class="p-4 flex justify-between items-center border-b dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-slate-800/50 transition">
                        <div class="flex items-center gap-3"><div class="bg-blue-50 dark:bg-slate-800 text-blue-600 p-2 rounded-lg"><i class="fa-solid fa-bell"></i></div><span class="font-bold text-gray-700 dark:text-gray-300">Notifications</span></div>
                        <label class="relative inline-flex items-center cursor-pointer"><input type="checkbox" id="notif-toggle" class="sr-only peer" onchange="toggleNotifications()"><div class="w-11 h-6 bg-gray-200 dark:bg-slate-600 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600 transition-all"></div></label>
                    </div>
                    <div class="p-4 flex justify-between items-center hover:bg-gray-50 dark:hover:bg-slate-800/50 transition">
                        <div class="flex items-center gap-3"><div class="bg-purple-50 dark:bg-slate-800 text-purple-600 p-2 rounded-lg"><i class="fa-solid fa-moon"></i></div><span class="font-bold text-gray-700 dark:text-gray-300">Dark Theme</span></div>
                        <label class="relative inline-flex items-center cursor-pointer"><input type="checkbox" id="theme-toggle" class="sr-only peer" onchange="toggleTheme()"><div class="w-11 h-6 bg-gray-200 dark:bg-slate-600 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-purple-600 transition-all"></div></label>
                    </div>
                </div>
                <button onclick="logout()" class="w-full bg-red-50 dark:bg-red-900/20 text-red-500 font-bold py-3.5 rounded-xl border border-red-100 dark:border-red-900 btn-anim hover:bg-red-100 dark:hover:bg-red-900/30 transition">Log Out</button>
            </div>
        </div>

        <!-- FIXED BOTTOM NAVIGATION -->
        <div id="bottom-nav" class="hidden fixed bottom-0 left-0 right-0 max-w-md mx-auto w-full bg-white dark:bg-darkCard border-t dark:border-gray-700 flex justify-around p-3 z-50 shadow-[0_-2px_10px_rgba(0,0,0,0.1)]">
            <button onclick="switchScreen('home')" id="nav-home" class="flex flex-col items-center nav-active btn-anim">
                <i class="fa-solid fa-house text-xl mb-1"></i><span class="text-[10px] font-bold">Home</span>
            </button>
            <button onclick="switchScreen('wallet')" id="nav-wallet" class="flex flex-col items-center nav-inactive btn-anim">
                <i class="fa-solid fa-wallet text-xl mb-1"></i><span class="text-[10px] font-bold">Wallet</span>
            </button>
            <button onclick="switchScreen('profile')" id="nav-profile" class="flex flex-col items-center nav-inactive btn-anim">
                <i class="fa-solid fa-user text-xl mb-1"></i><span class="text-[10px] font-bold">Profile</span>
            </button>
        </div>

        <!-- MODALS -->
        <!-- 1. JOIN MATCH MODAL -->
        <div id="join-modal" class="hidden fixed inset-0 bg-black/80 z-[60] flex items-center justify-center p-4 backdrop-blur-sm">
            <div class="bg-white dark:bg-darkCard w-full max-w-sm rounded-2xl p-6 animate-pop shadow-2xl">
                <h3 class="text-lg font-bold mb-4 dark:text-white">Join Match</h3>
                <input type="text" id="join-ff-name" class="w-full p-3 border dark:border-gray-600 rounded-xl mb-2 bg-gray-50 dark:bg-slate-800 dark:text-white focus:ring-1 focus:ring-blue-500 outline-none" placeholder="Game Name">
                <input type="number" id="join-ff-uid" class="w-full p-3 border dark:border-gray-600 rounded-xl mb-2 bg-gray-50 dark:bg-slate-800 dark:text-white focus:ring-1 focus:ring-blue-500 outline-none" placeholder="Game UID">
                <div class="flex gap-2 mt-4">
                    <button onclick="closeModal('join-modal')" class="flex-1 py-3 bg-gray-100 dark:bg-slate-700 dark:text-white rounded-xl font-bold btn-anim">Cancel</button>
                    <button onclick="confirmJoin()" class="flex-1 py-3 bg-blue-600 text-white rounded-xl font-bold shadow btn-anim">Join</button>
                </div>
            </div>
        </div>

        <!-- 2. GIVEAWAY JOIN MODAL -->
        <div id="giveaway-modal" class="hidden fixed inset-0 bg-black/80 z-[60] flex items-center justify-center p-4 backdrop-blur-sm">
            <div class="bg-white dark:bg-darkCard w-full max-w-sm rounded-2xl p-6 animate-pop shadow-2xl">
                <h3 class="text-lg font-bold mb-2 dark:text-white">Join Giveaway</h3>
                <p class="text-xs text-gray-500 mb-4">Enter details to confirm entry (Free).</p>
                <input type="text" id="g-join-name" class="w-full p-3 border dark:border-gray-600 rounded-xl mb-2 bg-gray-50 dark:bg-slate-800 dark:text-white focus:ring-1 focus:ring-purple-500 outline-none" placeholder="FF Name">
                <input type="number" id="g-join-uid" class="w-full p-3 border dark:border-gray-600 rounded-xl mb-2 bg-gray-50 dark:bg-slate-800 dark:text-white focus:ring-1 focus:ring-purple-500 outline-none" placeholder="FF UID">
                <input type="tel" id="g-join-mobile" class="w-full p-3 border dark:border-gray-600 rounded-xl mb-4 bg-gray-50 dark:bg-slate-800 dark:text-white focus:ring-1 focus:ring-purple-500 outline-none" placeholder="Mobile Number">
                <div class="flex gap-2">
                    <button onclick="closeModal('giveaway-modal')" class="flex-1 py-3 bg-gray-100 dark:bg-slate-700 dark:text-white rounded-xl font-bold btn-anim">Cancel</button>
                    <button onclick="confirmGiveawayJoin()" class="flex-1 py-3 bg-purple-600 text-white rounded-xl font-bold shadow btn-anim">Confirm Join</button>
                </div>
            </div>
        </div>

        <!-- 3. ROOM DETAILS -->
        <div id="room-modal" class="hidden fixed inset-0 bg-black/80 z-[60] flex items-center justify-center p-4 backdrop-blur-sm">
            <div class="bg-white dark:bg-darkCard w-full max-w-sm rounded-2xl p-6 text-center animate-pop shadow-2xl">
                <h3 class="text-lg font-bold mb-2 text-green-600">Room Details</h3>
                <div class="bg-gray-100 dark:bg-slate-800 p-4 rounded-xl mb-4">
                    <p class="text-sm text-gray-500 dark:text-gray-400">ID:</p><p class="text-2xl font-bold select-all dark:text-white" id="d-room-id">--</p>
                    <p class="text-sm text-gray-500 dark:text-gray-400 mt-2">Pass:</p><p class="text-2xl font-bold select-all dark:text-white" id="d-room-pass">--</p>
                </div>
                <button onclick="closeModal('room-modal')" class="w-full py-3 bg-blue-600 text-white rounded-xl font-bold btn-anim">Close</button>
            </div>
        </div>

        <!-- 4. DEPOSIT MODAL (WITH INSTANT UPLOAD) -->
        <div id="payment-modal" class="hidden fixed inset-0 bg-black/80 z-[80] flex items-center justify-center p-4 backdrop-blur-sm">
            <div class="bg-white dark:bg-darkCard w-full max-w-sm rounded-2xl p-6 animate-pop shadow-2xl">
                <div class="flex justify-between items-center mb-4"><h3 class="font-bold dark:text-white">Add Money</h3><button onclick="closeModal('payment-modal')" class="dark:text-white">X</button></div>
                <div class="bg-green-50 dark:bg-green-900/30 p-4 rounded-xl mb-4 text-center border border-green-200 dark:border-green-800">
                    <p class="text-[10px] text-green-600 dark:text-green-400 font-bold uppercase">Easypaisa</p>
                    <h2 class="text-xl font-black text-gray-800 dark:text-white select-all">0318 1068861</h2>
                </div>
                <input type="number" id="pay-amount" class="w-full p-3 border dark:border-gray-600 rounded-xl mb-2 bg-gray-50 dark:bg-slate-800 dark:text-white outline-none focus:border-green-500" placeholder="Amount Sent">
                <input type="tel" id="pay-sender-num" class="w-full p-3 border dark:border-gray-600 rounded-xl mb-2 bg-gray-50 dark:bg-slate-800 dark:text-white outline-none focus:border-green-500" placeholder="Sender Account Number">
                
                <p class="text-xs text-gray-500 mb-1 dark:text-gray-400">Upload Screenshot (Required)</p>
                <input type="file" id="pay-proof" accept="image/*" class="w-full p-2 border dark:border-gray-600 rounded-xl mb-4 text-sm dark:text-gray-300 bg-gray-50 dark:bg-slate-800">
                
                <button id="btn-submit-pay" onclick="submitDeposit()" class="w-full bg-blue-600 text-white font-bold py-3 rounded-xl shadow btn-anim">Submit Request</button>
            </div>
        </div>

        <!-- 5. WITHDRAW MODAL -->
        <div id="withdraw-modal" class="hidden fixed inset-0 bg-black/80 z-[80] flex items-center justify-center p-4 backdrop-blur-sm">
            <div class="bg-white dark:bg-darkCard w-full max-w-sm rounded-2xl p-6 animate-pop shadow-2xl">
                <div class="flex justify-between items-center mb-4"><h3 class="font-bold dark:text-white">Withdraw</h3><button onclick="closeModal('withdraw-modal')" class="dark:text-white">X</button></div>
                <input type="number" id="w-amount" class="w-full p-3 border dark:border-gray-600 rounded-xl mb-2 bg-gray-50 dark:bg-slate-800 dark:text-white outline-none focus:border-green-500" placeholder="Amount">
                <input type="tel" id="w-number" class="w-full p-3 border dark:border-gray-600 rounded-xl mb-2 bg-gray-50 dark:bg-slate-800 dark:text-white outline-none focus:border-green-500" placeholder="Account Number">
                <select id="w-method" class="w-full p-3 border dark:border-gray-600 rounded-xl mb-4 bg-white dark:bg-slate-800 dark:text-white">
                    <option value="Easypaisa">Easypaisa</option>
                </select>
                <button onclick="submitWithdraw()" class="w-full bg-green-600 text-white font-bold py-3 rounded-xl shadow btn-anim">Request</button>
            </div>
        </div>

        <!-- 6. REPORT HACKER -->
        <div id="hacker-modal" class="hidden fixed inset-0 bg-black/80 z-[100] flex items-center justify-center p-4 backdrop-blur-sm">
            <div class="bg-white dark:bg-darkCard w-full max-w-sm rounded-2xl p-6 border-2 border-red-500 animate-pop shadow-2xl">
                <div class="flex justify-between items-center mb-4 border-b dark:border-gray-700 pb-3"><h3 class="text-lg font-bold text-red-600">Report Hacker</h3><button onclick="closeModal('hacker-modal')" class="text-gray-400">X</button></div>
                <input type="text" id="h-uid" class="w-full p-3 border dark:border-gray-600 rounded-xl mb-3 bg-gray-50 dark:bg-slate-800 dark:text-white outline-none focus:border-red-500" placeholder="Hacker UID">
                <input type="tel" id="h-mobile" class="w-full p-3 border dark:border-gray-600 rounded-xl mb-3 bg-gray-50 dark:bg-slate-800 dark:text-white outline-none focus:border-red-500" placeholder="Your Mobile">
                <button onclick="submitHackerReport()" class="w-full bg-red-600 text-white font-bold py-3 rounded-xl shadow btn-anim">Submit Report</button>
            </div>
        </div>
    </div>

    <!-- JAVASCRIPT LOGIC -->
    <script>
        const firebaseConfig = { apiKey: "AIzaSyAvaUTUkNN9o4P1EZS_xvTd6roP4rA3HBE", authDomain: "tournaments-77bf7.firebaseapp.com", databaseURL: "https://tournaments-77bf7-default-rtdb.firebaseio.com", projectId: "tournaments-77bf7", storageBucket: "tournaments-77bf7.firebasestorage.app", messagingSenderId: "739367246432", appId: "1:739367246432:web:f10ace2277b88a57970105" };
        firebase.initializeApp(firebaseConfig); const db = firebase.database(); 
        const auth = firebase.auth();
        auth.signInAnonymously().catch(error => console.error("Auth Error", error));

        let user = { uid: null, name: null, mobile: null, balance: 0 };
        let selectedMatchId = null;
        let selectedGiveawayId = null;
        let filterType = 'All'; let filterMode = 'All';

        function initApp() {
            const theme = localStorage.getItem('theme');
            if(theme === 'dark') { document.documentElement.classList.add('dark'); if(document.getElementById('theme-toggle')) document.getElementById('theme-toggle').checked = true; }
            const storedUid = localStorage.getItem('arena_uid');
            if (storedUid) {
                user.uid = storedUid;
                db.ref('users/' + storedUid).once('value', snap => {
                    const data = snap.val();
                    if (data) { user.name = data.name; user.mobile = data.mobile; user.balance = data.balance || 0; showApp(); } else { logout(); }
                });
            }
        }
        
        function handleLogin() {
            const name = document.getElementById('login-name').value.trim();
            const phone = document.getElementById('login-phone').value.trim();
            if (!name || !phone) return alert("Please fill all fields");
            const uid = phone.replace(/\D/g, ''); 
            document.getElementById('btn-login').disabled = true; document.getElementById('btn-login').innerText = "Checking...";
            user = { uid: uid, name: name, mobile: phone, balance: 0 };
            db.ref('users/' + uid).update({ name: name, mobile: phone, lastLogin: firebase.database.ServerValue.TIMESTAMP }).then(() => { localStorage.setItem('arena_uid', uid); showApp(); });
        }

        function showApp() {
            document.getElementById('auth-screen').classList.add('hidden'); 
            document.getElementById('app-screens').classList.remove('hidden'); 
            document.getElementById('bottom-nav').classList.remove('hidden'); 
            document.getElementById('header-balance').classList.remove('hidden');
            
            document.getElementById('profile-name').innerText = user.name; document.getElementById('profile-phone').innerText = user.mobile;
            document.getElementById('theme-toggle').checked = document.documentElement.classList.contains('dark');
            document.getElementById('notif-toggle').checked = (localStorage.getItem('notif') === 'true');
            updateBalanceDisplay(); listenToBalance(); loadMatches(); loadGiveaways();
        }
        function logout() { localStorage.removeItem('arena_uid'); location.reload(); }

        // --- NAVIGATION & FILTERS ---
        function switchScreen(screen) {
            ['home', 'wallet', 'profile'].forEach(s => { document.getElementById('screen-' + s).classList.add('hidden'); document.getElementById('nav-' + s).className = "flex flex-col items-center nav-inactive"; });
            document.getElementById('screen-' + screen).classList.remove('hidden'); document.getElementById('nav-' + screen).className = "flex flex-col items-center nav-active";
            if(screen === 'wallet') loadHistory();
        }
        function switchHomeTab(tab) {
            document.getElementById('view-matches').classList.add('hidden'); document.getElementById('view-giveaways').classList.add('hidden');
            document.getElementById('htab-matches').className = "flex-1 pb-1 font-bold tab-inactive"; document.getElementById('htab-giveaways').className = "flex-1 pb-1 font-bold tab-inactive";
            document.getElementById('view-' + tab).classList.remove('hidden'); document.getElementById('htab-' + tab).className = "flex-1 pb-1 font-bold tab-active";
            if(tab === 'matches') document.getElementById('matches-filters').classList.remove('hidden'); else document.getElementById('matches-filters').classList.add('hidden');
        }
        function setFilterType(type) { filterType = type; updateFilters(); loadMatches(); }
        function setFilterMode(mode) { filterMode = mode; updateFilters(); loadMatches(); }
        function updateFilters() {
            ['All','CS','BR'].forEach(t => document.getElementById('btn-type-'+t).className = (t===filterType) ? "filter-type-active pb-1 transition" : "hover:text-blue-500 pb-1 transition");
            ['All','Squad','Duo','Solo'].forEach(m => document.getElementById('btn-mode-'+m).className = (m===filterMode) ? "filter-mode-active px-4 py-1.5 rounded-full text-xs font-bold transition shadow-sm btn-anim" : "filter-mode-inactive px-4 py-1.5 rounded-full text-xs font-bold transition btn-anim");
        }

        // --- MATCHES ---
        function loadMatches() {
            db.ref('tournaments').on('value', snap => {
                const list = document.getElementById('tournament-list'); list.innerHTML = ''; const data = snap.val();
                if (!data) { list.innerHTML = "<p class='text-center text-gray-400 pt-10'>No matches available</p>"; return; }
                Object.keys(data).reverse().forEach(key => {
                    const t = data[key];
                    let typeMatch = (filterType === 'All') || (filterType === 'CS' && t.gameMode.includes('CS')) || (filterType === 'BR' && t.gameMode.includes('BR'));
                    let modeMatch = (filterMode === 'All') || t.gameMode.includes(filterMode.toUpperCase());
                    if(!typeMatch || !modeMatch) return;
                    const isJoined = t.participants && t.participants[user.uid]; const count = t.participants ? Object.keys(t.participants).length : 0;
                    let actionBtn = isJoined ? `<button onclick="showRoom('${key}')" class="bg-green-600 text-white w-full py-2 rounded-lg font-bold text-sm shadow">Joined (View Room)</button>` : (!t.isJoinable ? `<button disabled class="bg-gray-300 text-gray-500 w-full py-2 rounded-lg font-bold text-sm">Closed</button>` : (count >= t.maxSlots ? `<button disabled class="bg-red-100 text-red-500 w-full py-2 rounded-lg font-bold text-sm">Full</button>` : `<button onclick="openJoinModal('${key}', ${t.fee})" class="bg-blue-600 text-white w-full py-2 rounded-lg font-bold text-sm shadow btn-anim">Join - â‚¹${t.fee}</button>`));
                    list.innerHTML += `<div class="bg-white dark:bg-darkCard rounded-xl p-4 shadow-sm border border-gray-100 dark:border-gray-700 relative overflow-hidden animate-slide-up hover:shadow-md transition"><div class="flex justify-between items-start mb-2"><div><span class="bg-blue-100 text-blue-600 px-2 py-0.5 rounded text-[10px] font-bold mb-1 inline-block">${t.gameMode}</span><h3 class="font-bold text-gray-800 dark:text-white text-lg leading-tight">${t.title}</h3><p class="text-xs text-gray-400 mt-1">${new Date(t.date).toLocaleString()}</p></div></div><div class="bg-gray-50 dark:bg-slate-800 rounded-lg p-2 mb-3 border dark:border-gray-700"><p class="text-[10px] text-center text-gray-500 mb-1 uppercase tracking-widest font-bold">Prize Pool</p><div class="flex justify-between items-center text-center"><div class="flex-1"><p class="text-[10px] text-gray-400">1st</p><p class="font-bold text-green-600 text-sm">â‚¹${t.p1||0}</p></div><div class="flex-1 border-l border-gray-200 dark:border-gray-600"><p class="text-[10px] text-gray-400">2nd</p><p class="font-bold text-blue-500 text-sm">â‚¹${t.p2||0}</p></div><div class="flex-1 border-l border-gray-200 dark:border-gray-600"><p class="text-[10px] text-gray-400">3rd</p><p class="font-bold text-orange-500 text-sm">â‚¹${t.p3||0}</p></div></div></div><div class="flex justify-between items-center mb-4 px-1"><div class="text-xs text-gray-500">Slots: <b class="text-gray-800 dark:text-white">${count}/${t.maxSlots}</b></div><div class="text-xs text-gray-500">Entry: <b class="text-blue-600 text-sm">â‚¹${t.fee}</b></div></div>${actionBtn}</div>`;
                });
            });
        }

        // --- GIVEAWAYS ---
        function loadGiveaways() {
            db.ref('giveaways').on('value', snap => {
                const list = document.getElementById('giveaway-list'); list.innerHTML = ''; const data = snap.val();
                if (!data) { list.innerHTML = "<p class='text-center text-gray-400 pt-10'>No Active Giveaways</p>"; return; }
                Object.keys(data).reverse().forEach(key => {
                    const g = data[key]; const isJoined = g.participants && g.participants[user.uid]; const count = g.participants ? Object.keys(g.participants).length : 0;
                    let btn = isJoined ? `<button disabled class="w-full bg-green-100 text-green-700 font-bold py-2 rounded-lg">Joined</button>` : (count >= g.maxSlots ? `<button disabled class="w-full bg-gray-200 text-gray-500 font-bold py-2 rounded-lg">Full</button>` : `<button onclick="openGiveawayJoinModal('${key}')" class="w-full bg-purple-600 text-white font-bold py-2 rounded-lg shadow btn-anim">Free Join</button>`);
                    list.innerHTML += `<div class="bg-white dark:bg-darkCard rounded-xl p-4 shadow-sm border border-purple-100 dark:border-purple-900 animate-slide-up"><div class="flex justify-between items-center mb-2"><h3 class="font-bold text-purple-700">${g.title}</h3><span class="text-[10px] bg-purple-50 text-purple-600 px-2 py-1 rounded">Free</span></div><p class="text-xs text-gray-500 mb-3">Draw: ${new Date(g.date).toLocaleString()}</p><div class="grid grid-cols-3 gap-1 text-center text-xs mb-3 bg-gray-50 dark:bg-slate-800 p-2 rounded"><div><b class="text-green-600">ðŸ¥‡ ${g.p1||0}</b></div><div><b class="text-blue-600">ðŸ¥ˆ ${g.p2||0}</b></div><div><b class="text-orange-600">ðŸ¥‰ ${g.p3||0}</b></div></div>${btn}<p class="text-[10px] text-center text-gray-400 mt-2">${count} Players Joined</p></div>`;
                });
            });
        }

        function openGiveawayJoinModal(gid) {
            selectedGiveawayId = gid;
            document.getElementById('g-join-name').value = ''; document.getElementById('g-join-uid').value = ''; document.getElementById('g-join-mobile').value = user.mobile; 
            document.getElementById('giveaway-modal').classList.remove('hidden');
        }

        function confirmGiveawayJoin() {
            const name = document.getElementById('g-join-name').value; const uid = document.getElementById('g-join-uid').value; const mob = document.getElementById('g-join-mobile').value;
            if(!name || !uid || !mob) return alert("Fill all details to join!");
            db.ref(`giveaways/${selectedGiveawayId}/participants/${user.uid}`).set({ ffName: name, ffUid: uid, mobile: mob, joinedAt: firebase.database.ServerValue.TIMESTAMP }).then(() => { closeModal('giveaway-modal'); alert("ðŸŽ‰ Joined Giveaway Successfully!"); });
        }

        // --- MODALS & ACTIONS ---
        function openModal(id) { document.getElementById(id).classList.remove('hidden'); }
        function closeModal(id) { document.getElementById(id).classList.add('hidden'); }

        function openJoinModal(mid, fee) {
            if (user.balance < fee) return alert("Insufficient Balance! Please Add Money.");
            selectedMatchId = mid;
            document.getElementById('join-ff-name').value = ''; document.getElementById('join-ff-uid').value = '';
            openModal('join-modal');
        }
        function confirmJoin() {
            const ffName = document.getElementById('join-ff-name').value; const ffUid = document.getElementById('join-ff-uid').value;
            if(!ffName || !ffUid) return alert("Enter Game Details");
            db.ref(`tournaments/${selectedMatchId}`).once('value', snap => {
                const t = snap.val();
                if(t.participants && Object.keys(t.participants).length >= t.maxSlots) return alert("Match Full");
                const updates = {}; updates[`users/${user.uid}/balance`] = user.balance - t.fee; updates[`tournaments/${selectedMatchId}/participants/${user.uid}`] = { ffName: ffName, ffUid: ffUid, mobile: user.mobile };
                db.ref().update(updates).then(() => { closeModal('join-modal'); alert("Joined Successfully!"); }).catch(e => alert(e.message));
            });
        }
        function showRoom(mid) {
            db.ref(`tournaments/${mid}`).once('value', s => { const t = s.val(); document.getElementById('d-room-id').innerText = t.roomId || "Wait"; document.getElementById('d-room-pass').innerText = t.roomPass || "Wait"; openModal('room-modal'); });
        }

        // --- WALLET ---
        function listenToBalance() { db.ref(`users/${user.uid}/balance`).on('value', s => { user.balance = s.val() || 0; updateBalanceDisplay(); }); }
        function updateBalanceDisplay() { document.getElementById('header-balance').innerText = "â‚¹" + user.balance; document.getElementById('wallet-balance').innerText = "â‚¹" + user.balance; }

        // --- FAST DEPOSIT (IMAGE BASE64 - NO STORAGE RULES NEEDED) ---
        function submitDeposit() {
            const amt = document.getElementById('pay-amount').value;
            const senderNum = document.getElementById('pay-sender-num').value;
            const fileInput = document.getElementById('pay-proof');
            const file = fileInput.files[0];

            if(!amt || !senderNum || !file) return alert("âš ï¸ Please fill Amount, Sender Number & Upload Proof");

            const btn = document.getElementById('btn-submit-pay');
            btn.disabled = true;
            btn.innerText = "Sending...";

            // Read & Compress Image (Client Side)
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = function(event) {
                const img = new Image();
                img.src = event.target.result;
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    const MAX_WIDTH = 500;
                    const scaleSize = MAX_WIDTH / img.width;
                    canvas.width = MAX_WIDTH;
                    canvas.height = img.height * scaleSize;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    const dataUrl = canvas.toDataURL('image/jpeg', 0.5);

                    // Direct DB Push
                    db.ref('payment_requests').push({
                        userId: user.uid, userName: user.name, userMobile: user.mobile, 
                        senderMobile: senderNum, amount: Number(amt), 
                        proof: dataUrl, status: 'pending', date: firebase.database.ServerValue.TIMESTAMP
                    }).then(() => {
                        alert("âœ… Request Sent Successfully!");
                        closeModal('payment-modal');
                        document.getElementById('pay-amount').value = '';
                        document.getElementById('pay-sender-num').value = '';
                        fileInput.value = '';
                    }).catch(error => alert("Error: " + error.message))
                    .finally(() => { btn.disabled = false; btn.innerText = "Submit Request"; });
                }
            };
        }

        function submitWithdraw() {
            const amt = Number(document.getElementById('w-amount').value); const num = document.getElementById('w-number').value; const method = document.getElementById('w-method').value;
            if(!amt || !num || amt > user.balance) return alert("Invalid Details");
            const updates = {}; const reqKey = db.ref('withdraw_requests').push().key;
            updates[`withdraw_requests/${reqKey}`] = { userId: user.uid, name: user.name, mobile: num, amount: amt, method: method, status: 'pending', date: firebase.database.ServerValue.TIMESTAMP };
            updates[`users/${user.uid}/balance`] = user.balance - amt;
            db.ref().update(updates).then(() => { closeModal('withdraw-modal'); alert("Withdraw Requested"); });
        }
        function loadHistory() { document.getElementById('payment-history').innerHTML = '<p class="text-center mt-4">Check Admins Response for updates</p>'; }

        // --- SETTINGS ---
        function toggleTheme() { if(document.documentElement.classList.contains('dark')) { document.documentElement.classList.remove('dark'); localStorage.setItem('theme', 'light'); } else { document.documentElement.classList.add('dark'); localStorage.setItem('theme', 'dark'); } }
        function toggleNotifications() { const status = document.getElementById('notif-toggle').checked; localStorage.setItem('notif', status); alert(status ? "Notifications Enabled (UI Only)" : "Notifications Disabled"); }
        function submitHackerReport() { const uid = document.getElementById('h-uid').value; const mob = document.getElementById('h-mobile').value; if(!uid || !mob) return alert("All fields required"); alert("Hacker Report temporarily disabled."); }

        initApp();
    </script>
</body>
</html>